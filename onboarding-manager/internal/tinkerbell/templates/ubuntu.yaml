# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
name: ubuntu
version: "0.1" # must stay at 0.1 due to v0.10.0 limitations
global_timeout: 9800
tasks:
  - name: "OS provisioning"
    worker: {{ .DeviceInfoHwMacID }}
    volumes:
      - /dev:/dev
      - /dev/console:/dev/console
      - /lib/firmware:/lib/firmware:ro
    actions:
      - name: "secure-boot-status-flag-read"
        image: {{ .TinkerActionImageSecureBootFlagRead }}
        timeout: 560
        volumes:
          - /:/host:rw
        environment:
          SECURITY_FEATURE_FLAG: "{{ .DeviceInfoSecurityFeature }}"
      - name: "erase-non-removable-disk"
        image: {{ .TinkerActionImageEraseNonRemovableDisk }}
        timeout: 560
      - name: "stream-os-image"
        image: {{ .TinkerActionImageQemuNbdImage2Disk }}
        timeout: 9800
        volumes:
          - /run:/run:rw
          - /tmp:/tmp:rw
          - /var:/var:rw
          - /dev/nbd0:/dev/nbd0:rw
        pid: "host"
        environment:
          IMG_URL: {{ .DeviceInfoOSImageURL }}
          SHA256: {{ .DeviceInfoOsImageSHA256 }}
          HTTP_PROXY: {{ .EnvENProxyHTTP }}
          HTTPS_PROXY: {{ .EnvENProxyHTTPS }}
          NO_PROXY: {{ .EnvENProxyNoProxy }}
          TLS_CA_CERT: "-----BEGIN CERTIFICATE-----
MIIF4zCCA8ugAwIBAgIULcOa8z1yw743lElu04pRCiwtJ0swDQYJKoZIhvcNAQEL
BQAwajELMAkGA1UEBhMCVVMxDjAMBgNVBAgMBVN0YXRlMQ0wCwYDVQQHDARDaXR5
MRUwEwYDVQQKDAxPcmdhbml6YXRpb24xCzAJBgNVBAsMAklUMRgwFgYDVQQDDA9u
Z2lueC1vcy1zZXJ2ZXIwHhcNMjUxMDE0MDMzOTM2WhcNMjYxMDE0MDMzOTM2WjBq
MQswCQYDVQQGEwJVUzEOMAwGA1UECAwFU3RhdGUxDTALBgNVBAcMBENpdHkxFTAT
BgNVBAoMDE9yZ2FuaXphdGlvbjELMAkGA1UECwwCSVQxGDAWBgNVBAMMD25naW54
LW9zLXNlcnZlcjCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAMJDuI6D
bTNZzVLDwp5TjPPvz7434Pz2HzxPCZ/1FuEgMNfKYFN/Ro8tX+F6Q2qYx8qPfLUj
XOnyHNBqVFbkEeVAt3BCK/oGWuaA3N3u//8u1h7PWecraBMJcr4OCysBY4Gftb5v
1kLFMKMaDLDOJDL9zLKggBgz5kbxEWaoMq9RLcka5Oepolpp1F3L+VEtbHWNRf3p
69b/64pok8oM2jOb4TG43jqT4cCQSYPmeMgYIo0KFCy9DkWaxVF/wzEWmadPctCT
PvzQBaoqsH4OKYO72hSEK6YzTDgrxSeZ5Po3L0ORqkjFP0xy+ekICoHRYL/3k9tp
X37NSzERdG+iA8Fjo/M9K6dVuKQlu+aY+wa8/+rAolRNObeWVIgEaQ+ru0oAt8xg
bH2Rq9WcYPlOcvcoiwyS5wePNdZc6gqQ4veDuMJvlyhHsbJskioe39B5picHPNpE
LCv/neLpWrxmewqdaTosEqpKo5zJ/Yw3ESFSbVp3GXjGl7cLgmJp5ZEUZ2T5hSw4
1cA1/BZ92sa0RAGluHRUIq8/R/hRPHTfoEQ8A0R348WlKezFblWtHg+vAAljsI7Z
UVgaqq8+1fWEPaneSwAEe5D+J+LLiNaS0ZBjo+rjYYDOLMhEHq8isWh4vrrgiEGd
qWYs8TYp+vIeGXQ0ZV6l2dyIpBL1KnDS4Cd7AgMBAAGjgYAwfjAdBgNVHQ4EFgQU
Fi5Wqoo+8BToMas5ku5OCGcx63kwHwYDVR0jBBgwFoAUFi5Wqoo+8BToMas5ku5O
CGcx63kwDwYDVR0TAQH/BAUwAwEB/zArBgNVHREEJDAigglsb2NhbGhvc3SCD25n
aW54LW9zLXNlcnZlcocEfwAAATANBgkqhkiG9w0BAQsFAAOCAgEAsnl5GU403uTt
lKpw1/mOP40tIdOg1IyihtLujZo3lnK45YLYzV9kZr5Rhp62dKHP5yx5+xA44Loy
zHfGprGXxRmkfqChEKSvD4owmbXOODQHBS3DYwskquatpssotEqt5f9B+ItCE2gu
OEczxcxzq7eoAmRi/demx6/pC/qZ6dThNZsmKSy/bCUOeYEK7wXm17BN1DaT82y/
+LmSwEgTy9S81zZFXMnBR60WkVf8XfCWX2nSDlV/mqWzkfqndHNESzuPtBz6SVEf
eoGQcBA7IgxGztSzj8iNAcIpaw02IGNGhwE49slsE4KTkE4sbVhfERzp63gpOvDZ
ZEpAJEyNh8qykSMbgdJN4A1g6OBCb5MFtWNTEiK3lrYVt3aydByK4UPpkcbeaeeI
EXN1q8sBY0J5frM/Ma+I4cwsa4EddiMK53xLg1Ycz/Lkrvtqgni/Rda3j/RYDSot
Ugen20nO5Piwvh4XPPkb/Jz1crHjVWHL2lICBQsXIc2R/P80UKCDRHsrEn1wZnay
oQHO9U7V9BKRMaWehIAiIU3Ek0pf20zwlcvxINHtnvZaMcQripViaGaCuItu3Ct9
I9bPyZhz710sI1R7u3EetUc1zREH4VGQ3239wHcyhD07tnxOyL6OsATxLbFYJWks
i1P+53qUcgDOECgwRDZBamwXSNBhVyw=
-----END CERTIFICATE-----"
      - name: "add-apt-proxy"
        image: {{ .TinkerActionImageWriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          DEST_PATH: /etc/apt/apt.conf
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          CONTENTS: |
            Acquire::http::Proxy "{{ .EnvENProxyHTTP }}";
            Acquire::https::Proxy "{{ .EnvENProxyHTTPS }}";
      - name: "install-cloud-init"
        image: {{ .TinkerActionImageWriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          DEST_PATH: /etc/cloud/cloud.cfg.d/99_infra.cfg
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          CONTENTS: {{ .CloudInitData }}
{{- if gt (len .CustomConfigs) 0 }}
      - name: "custom-configs"
        image: {{ .TinkerActionImageWriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          DEST_PATH: /etc/cloud/cloud.cfg.d/custom.cfg
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          CONTENTS: {{ .CustomConfigs }}
      - name: "custom-configs-split"
        image: {{ .TinkerActionImageCexec }}
        timeout: 200
        environment:
          FS_TYPE: ext4
          CHROOT: y
          DEFAULT_INTERPRETER: "/bin/sh -c"
          CMD_LINE: |
            awk -v RS='\x1F' 'BEGIN{i=0} {
              fn=sprintf("/etc/cloud/cloud.cfg.d/%02d_infra.cfg", i++);
              print > fn; close(fn); system("chmod 755 " fn)
            }' /etc/cloud/cloud.cfg.d/custom.cfg &&
            rm -f /etc/cloud/cloud.cfg.d/custom.cfg
{{- end }} 
      - name: "cloud-init-ds-identity"
        image: {{ .TinkerActionImageWriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          UID: 0
          GID: 0
          MODE: "0600"
          DIRMODE: "0700"
          DEST_PATH: /etc/cloud/ds-identify.cfg
          CONTENTS: |
            datasource: NoCloud
      - name: "profile-pkg-and-node-agents-install-script-download"
        image: {{ .TinkerActionImageWriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          DEST_PATH: /home/postinstall/Setup/installer.sh
          CONTENTS: {{ .InstallerScript }}
      - name: "service-script-for-profile-pkg-and-node-agents-install"
        image: {{ .TinkerActionImageWriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          UID: 0
          GID: 0
          MODE: "0644"
          DIRMODE: "0755"
          DEST_PATH: /etc/systemd/system/install-profile-pkgs-and-node-agent.service
          CONTENTS: |
            [Unit]
            Description=Profile and node agents Package Installation
            After=update-netplan.service getty@tty1.service
            ConditionPathExists = !/home/postinstall/Setup/.base_pkg_install_done
      
            [Service]
            ExecStartPre=/bin/sleep 10
            WorkingDirectory=/home/postinstall/Setup
            ExecStart=/home/postinstall/Setup/installer.sh
            StandardOutput=tty
            StandardError=tty
            TTYPath=/dev/tty1
            Restart=always
      
            [Install]
            WantedBy=multi-user.target
      - name: "system-configuration"
        image: {{ .TinkerActionImageCexec }}
        timeout: 200
        environment:
          FS_TYPE: ext4
          CHROOT: y
          DEFAULT_INTERPRETER: "/bin/sh -c"
          CMD_LINE: "
          systemctl enable install-profile-pkgs-and-node-agent.service &&
          sed -i 's|ExecStart=/lib/systemd/systemd-networkd-wait-online|ExecStart=/lib/systemd/systemd-networkd-wait-online --timeout=5|' /usr/lib/systemd/system/systemd-networkd-wait-online.service &&
          systemctl disable snapd.seeded.service"
{{- if eq .DeviceInfoSecurityFeature "SECURITY_FEATURE_SECURE_BOOT_AND_FULL_DISK_ENCRYPTION" }}
      - name: "fde-encryption"
        image: {{ .TinkerActionImageFdeDmv }}
        timeout: 560
        environment:
          LVM_SIZE: {{ .DeviceInfoUserLVMSize }}
{{- end }}
      - name: "kernel-upgrade"
        image: {{ .TinkerActionImageKernelUpgrade }}
        timeout: 9800
        environment:
          LVM_SIZE: {{ .DeviceInfoUserLVMSize }}
      - name: "efibootset-for-diskboot"
        image: {{ .TinkerActionImageEfibootset }}
        timeout: 560
      - name: "reboot"
        image: public.ecr.aws/l0g8r8j6/tinkerbell/hub/reboot-action:latest
        timeout: 90
        volumes:
          - "/worker:/worker"
