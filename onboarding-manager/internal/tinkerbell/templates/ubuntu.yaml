name: ubuntu
version: "0.1.0"
global_timeout: 9800
tasks:
  - name: "OS provisioning"
    worker: {{ .WorkerID }}
    volumes:
      - /dev:/dev
      - /dev/console:/dev/console
      - /lib/firmware:/lib/firmware:ro
    actions:
      - name: "secure-boot-status-flag-read"
        image: {{ .TinkerActionImage.SecureBootFlagRead }}
        timeout: 560
        volumes:
          - /:/host:rw
        environment:
          SECURITY_FEATURE_FLAG: {{ .DeviceInfo.SecurityFeature }}
      - name: "erase-non-removable-disk"
        image: {{ .TinkerActionImage.EraseNonRemovableDisk }}
        timeout: 560
      - name: "stream-ubuntu-image"
        image: {{ .TinkerActionImage.QemuNbdImage2Disk }}
        timeout: 9800
        pid: "host"
        environment:
          IMG_URL: {{ .DeviceInfo.OSImageURL }}
          SHA256: {{ .DeviceInfo.OsImageSHA256 }}
          HTTP_PROXY: {{ .Env.ENProxyHTTP }}
          HTTPS_PROXY: {{ .Env.ENProxyHTTPS }}
          NO_PROXY: {{ .Env.ENProxyNoProxy }}
      - name: "add-apt-proxy"
        image: {{ .TinkerActionImage.WriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          DEST_PATH: /etc/apt/apt.conf
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          CONTENTS: |
            Acquire::http::Proxy "{{ .Env.ENProxyHTTP }}";
            Acquire::https::Proxy "{{ .Env.ENProxyHTTPS }}";
      - name: "install-cloud-init"
        image: {{ .TinkerActionImage.WriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          DEST_PATH: /etc/cloud/cloud.cfg.d/infra.cfg
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          CONTENTS: |
            {{ .CloudInitData }}
      - name: "cloud-init-ds-identity"
        image: {{ .TinkerActionImage.WriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          UID: 0
          GID: 0
          MODE: "0600"
          DIRMODE: "0700"
          DEST_PATH: /etc/cloud/ds-identify.cfg
          CONTENTS: |
            datasource: NoCloud
      - name: "profile-pkg-and-node-agents-install-script-download"
        image: {{ .TinkerActionImage.WriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          UID: 0
          GID: 0
          MODE: "0755"
          DIRMODE: "0755"
          DEST_PATH: /home/postinstall/Setup/installer.sh
          CONTENTS: {{ .InstallerScript }}
      - name: "service-script-for-profile-pkg-and-node-agents-install"
        image: {{ .TinkerActionImage.WriteFile }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          UID: 0
          GID: 0
          MODE: "0644"
          DIRMODE: "0755"
          DEST_PATH: /etc/systemd/system/install-profile-pkgs-and-node-agent.service
          CONTENTS: |
            [Unit]
            Description=Profile and node agents Package Installation
            After=update-netplan.service getty@tty1.service
            ConditionPathExists = !/home/postinstall/Setup/.base_pkg_install_done
      
            [Service]
            ExecStartPre=/bin/sleep 10
            WorkingDirectory=/home/postinstall/Setup
            ExecStart=/home/postinstall/Setup/installer.sh
            StandardOutput=tty
            StandardError=tty
            TTYPath=/dev/tty1
            Restart=always
      
            [Install]
            WantedBy=multi-user.target
      - name: "enable-service-script-for-profile-pkg-node-agents"
        image: {{ .TinkerActionImage.Cexec }}
        timeout: 200
        environment:
          FS_TYPE: ext4
          CHROOT: y
          DEFAULT_INTERPRETER: "/bin/sh -c"
          CMD_LINE: "systemctl enable install-profile-pkgs-and-node-agent.service"
      - name: "systemd-network-online-optimize"
        image: {{ .TinkerActionImage.Cexec }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          CHROOT: y
          DEFAULT_INTERPRETER: "/bin/sh -c"
          CMD_LINE: "sed -i 's|ExecStart=/lib/systemd/systemd-networkd-wait-online|ExecStart=/lib/systemd/systemd-networkd-wait-online --timeout=5|' /usr/lib/systemd/system/systemd-networkd-wait-online.service"
      - name: "systemd-snapd-disable-optimize"
        image: {{ .TinkerActionImage.Cexec }}
        timeout: 90
        environment:
          FS_TYPE: ext4
          CHROOT: y
          DEFAULT_INTERPRETER: "/bin/sh -c"
          CMD_LINE: "systemctl disable snapd.seeded.service"
{{- if eq .DeviceInfo.SecurityFeature "SECURITY_FEATURE_SECURE_BOOT_AND_FULL_DISK_ENCRYPTION" }}
      - name: "fde-encryption"
        image: {{ .TinkerActionImage.FdeDmv }}
        timeout: 560
{{- end }}
      - name: "kernel-upgrade"
        image: {{ .TinkerActionImage.KernelUpgrade }}
        timeout: 9800
      - name: "efibootset-for-diskboot"
        image: {{ .TinkerActionImage.Efibootset }}
        timeout: 560
      - name: "reboot"
        image: public.ecr.aws/l0g8r8j6/tinkerbell/hub/reboot-action:latest
        timeout: 90
        volumes:
          - "/worker:/worker"
