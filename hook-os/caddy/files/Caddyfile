# INTEL CONFIDENTIAL
# Copyright (C) 2024 Intel Corporation
#
# This software and the related documents are Intel copyrighted materials, and
# your use of them is governed by the express license under which they were
# provided to you ("License"). Unless the License provides otherwise, you may
# not use, modify, copy, publish, distribute, disclose or transmit this
# software or the related documents without Intel's prior written permission.
#
# This software and the related documents are provided as is, with no express
# or implied warranties, other than those that are expressly stated in the
# License.
# SPDX-License-Identifier: LicenseRef-Intel

{
    servers {
        protocols h1 h2 h2c
    }

    log {
        level DEBUG
        format filter {
            wrap console
            fields {
                resp_headers delete
                request>headers delete
                request>tls delete
            }
        }
    }
}

# Proxy server for fileserver access
localhost:443 {
    bind 127.0.0.1
    tls /etc/caddy/caddy-cert.pem /etc/caddy/caddy-key.pem
    reverse_proxy {$release_svc}:443 {
        header_up Authorization "Bearer {$release_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
        }
    }
}

# Proxy server for OCI release service
localhost:7443 {
    bind 127.0.0.1 
    tls /etc/caddy/caddy-cert.pem /etc/caddy/caddy-key.pem
    reverse_proxy {$oci_release_svc}:443 {
        header_up Authorization "Bearer {$release_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
        }
    }
}

# Proxy server for FDO manufacturer service
localhost.internal:8081 {
    tls /etc/caddy/caddy-cert.pem /etc/caddy/caddy-key.pem

    respond /health "Caddy healthy!!" 200

    reverse_proxy /fdo/101/msg/10 {$fdo_manufacturer_svc}:443 {
	header_up Authorization "Bearer {$access_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$fdo_manufacturer_svc}
        }
    }

    reverse_proxy {$fdo_manufacturer_svc}:443 {
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$fdo_manufacturer_svc}
        }
    }
}

# Proxy server for FDO owner service
localhost.internal:8082 {
    tls /etc/caddy/caddy-cert.pem /etc/caddy/caddy-key.pem

    respond /health "Caddy healthy!!" 200


    reverse_proxy /fdo/101/msg/60 {$fdo_owner_svc}:443 {
        header_up Authorization "Bearer {$access_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$fdo_owner_svc}
        }
    }

    reverse_proxy {$fdo_owner_svc}:443 {
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$fdo_owner_svc}
        }
    }
}

# Proxy server(HTTP) to route tink stack routes 
:80 {
    reverse_proxy /tink-stack/* {$tink_stack_svc}:443 {
        header_up Authorization "Bearer {$access_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$tink_stack_svc}
        }
    }
    reverse_proxy /repository/* {$release_svc}:443 {
        header_up Authorization "Bearer {$release_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$release_svc}
        }
    }
}

# GRPC Proxy server for tink server
:42113 {
    reverse_proxy {$tink_server_svc}:443 {
        header_up Authorization "Bearer {$access_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$tink_server_svc}
        }
    }
}

# Server to route fluent-bit logs to Loki/Grafana
localhost:24224 {
    bind 127.0.0.1 
    tls /etc/caddy/caddy-cert.pem /etc/caddy/caddy-key.pem
    reverse_proxy {$logging_svc}:443 {
        header_up Authorization "Bearer {$access_token}"
        header_up Host {upstream_hostport}

        transport http {
            tls
            tls_server_name {$logging_svc}
        }
    }
}
